{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/baseHandler.ts", "../src/reactive.ts"],
  "sourcesContent": ["export let activeEffect;\r\n\r\n//\u6E05\u7406\u4F9D\u8D56\u7684\u6536\u96C6\r\nfunction clearUpEffect(effect) {\r\n  let { deps } = effect;\r\n  //\u5C06\u4F9D\u8D56\u83B7\u53D6\u5230\r\n  for (let index = 0; index < deps.length; index++) {\r\n    //\u6E05\u9664\u4F9D\u8D56\r\n    delete deps[index];\r\n  }\r\n  //\u6570\u7EC4\u957F\u5EA6\u5F520\r\n  effect.deps.length = 0;\r\n}\r\n\r\nclass ReactiveEffect {\r\n  public fn;\r\n  public active = true; //\u662F\u5426\u6FC0\u6D3B\r\n  public deps = []; //\u65B9\u6CD5\u4E2D\u6709\u90A3\u4E9B\u4F9D\u8D56\u9879\r\n  public parent = undefined;\r\n  constructor(fn) {\r\n    this.fn = fn;\r\n  }\r\n\r\n  run() {\r\n    //\u672A\u6FC0\u6D3B\u7684\u72B6\u6001\r\n    if (!this.active) {\r\n      return this.fn(); //\u76F4\u63A5\u6267\u884C\r\n    }\r\n\r\n    //\u5176\u4ED6\u610F\u5473\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001\r\n    try {\r\n      //tree\u6811 \u7236\u5B50\u5173\u7CFB\r\n      this.parent = activeEffect;\r\n      activeEffect = this;\r\n      //\u6E05\u9664\u4E4B\u524D\u7684\u4F9D\u8D56\u6536\u96C6\r\n      clearUpEffect(this);\r\n      return this.fn(); //\u6267\u884C\u65B9\u6CD5 \u5982\u679C\u6709\u4EE3\u7406\u5C31\u4F1A\u89E6\u53D1\u4EE3\u7406\r\n    } finally {\r\n      //\u65E0\u8BBA\u4EFB\u4F55\u60C5\u51B5\u90FD\u4F1A\u6267\u884C\r\n      activeEffect = this.parent;\r\n      this.parent = undefined;\r\n    }\r\n  }\r\n  //\u505C\u6B62effect\r\n  stop() {\r\n    //\u5982\u679C\u72B6\u6001\u662F\u6D3B\u52A8\u7684 \u5C31\u6539\u4E3A\u5931\u6D3B \u540C\u65F6\u6E05\u7A7A\u6240\u6709\u7684\u4F9D\u8D56\r\n    if (this.active) {\r\n      clearUpEffect(this);\r\n      this.active = false;\r\n      console.log(\"\u6E05\u9664\u662F\u6709\u7684\");\r\n    }\r\n  }\r\n}\r\n//\u4F9D\u8D56\u6536\u96C6 \u5C31\u662F\u5F53\u524D\u7684effect\u53D8\u6210\u5168\u5C40\u7684 \u7A0D\u540E\u53D6\u503C\u7684\u65F6\u5019\u53EF\u4EE5\u62FF\u5230\u8FD9\u4E2A\u5168\u5C40\u7684effect\r\nexport function effect(fn) {\r\n  const _effect = new ReactiveEffect(fn);\r\n  _effect.run(); //\u9ED8\u8BA4\u8BA9\u54CD\u5E94\u5F0F\u7684\u8D70\u4E00\u904D\r\n\r\n  const runner = _effect.run.bind(_effect); //\u4FDD\u8BC1runner\u88AB\u8C03\u53D6\u7684\u65F6\u5019 this\u7684\u6307\u5411\u4E0D\u4F1A\u4E22\u5931\r\n  runner.effect = _effect;\r\n  return runner;\r\n}\r\n\r\n/* let targetMap={\r\n    depsMap:{\r\n        key:[activeEffect,activeEffect]\r\n   }\r\n}*/\r\nconst targetMap = new WeakMap();\r\nexport function track(target, key) {\r\n  if (!activeEffect) {\r\n    //\u53D6\u503C\u64CD\u4F5C\u4E2D \u5E76\u672A\u5728effect\u4E2D \u5C31\u4E0D\u9700\u8981\u8FDB\u884C\u6536\u96C6\r\n    return;\r\n  }\r\n  let depsMap = targetMap.get(target);\r\n  if (!depsMap) {\r\n    //\u5E76\u672A\u5B58\u50A8\u8FC7 \u6240\u4EE5\u8981\u5B58\u50A8\u4E0B\r\n    //WeakMap \u53EA\u80FD\u662F\u5BF9\u8C61 \u4F46\u662F\u6211\u5148\u8981\u50A8\u5B58key  key\u662F\u5B57\u7B26\u4E32\r\n    targetMap.set(target, (depsMap = new Map()));\r\n  }\r\n\r\n  let dep = depsMap.get(key);\r\n  if (!dep) {\r\n    depsMap.set(key, (dep = new Set()));\r\n  }\r\n  //\u662F\u5426\u9700\u8981\u8FDB\u884C\u6536\u96C6\r\n  let shouldTrack = !dep.has(activeEffect);\r\n  if (shouldTrack) {\r\n    //\u5C06\u5BF9\u5E94\u7684effect\u6536\u96C6\u8D77\u6765\r\n    dep.add(activeEffect);\r\n    //activeEffect\u4E5F\u5C06\u5BF9\u5E94\u7684dep\u6536\u96C6\u8D77\u6765\uFF0C\u4E5F\u5C31\u662Fkey\u503C\u5BF9\u5E94\u7684effect\u7684\u65B9\u6CD5\r\n    activeEffect.deps.push(dep); //\u540E\u7EED\u9700\u8981\u901A\u8FC7effect\u6765\u6E05\u7406\u7684\u65F6\u5019\u53EF\u4EE5\u53BB\u4F7F\u7528\r\n    //\u4E00\u4E2A\u5C5E\u6027\u5BF9\u5E94\u591A\u4E2Aeffect  \u4E00\u4E2Aeffect\u5BF9\u5E94\u591A\u4E2A\u5C5E\u6027\r\n    //\u5C5E\u6027\u4E0Eeffect\u662F\u591A\u5BF9\u591A\u7684\u5173\u7CFB\r\n  }\r\n}\r\n// let activeEffect;\r\n// effect(() => { //e1  el.parent = null\r\n//   name;\r\n//   effect(() => {//e2  el.parent = e1\r\n//     age;\r\n//   });//e2  activeEffect = e2.parent\r\n//   address\r\n// });\r\n\r\nexport function trigger(target, key, newValue, oldValue) {\r\n  // waakMap:(obj:map(key:set(effect)))\r\n  //\u83B7\u53D6target\u7684map\r\n  const depMap = targetMap.get(target);\r\n  if (!depMap) return;\r\n  //\u83B7\u53D6target\u7684\u4E2Dkey\u7684\u96C6\u5408\r\n  const dep = depMap.get(key);\r\n  if (dep) {\r\n    //\u9632\u6B62\u51FA\u73B0 //\u89E3\u91CA1\r\n    const effects = [...dep];\r\n    effects.forEach((effect) => {\r\n      //\u5F53\u6267\u884C\u65F6 \u5C06effect\u65B9\u5168\u5C40\u4E0A \u4E0B\u9762\u662F\u4E3A\u4E86\u5904\u7406\u6389 effect()\u4E2D\u6267\u884C\u7684\u65B9\u6CD5\uFF0C\u6709\u6539\u53D8\u91CF\u7684\u503C\u3002\u800C\u8FD9\u4E2A\u503C\u540C\u65F6\u53C8\u6536\u96C6\u4E86\u8FD9\u4E2A\u4F9D\u8D56\r\n      //\u4F8B\u5B50\r\n      // let data = reactive({name:haha,age:18})\r\n      // effect(()=>{\r\n      // data.name = guagua //\u89E6\u53D1\u6536\u96C6\u7684effect\u7684\u4F9D\u8D56 \u8FD0\u884C\r\n      // app.inntrtHTML = data.name \u89E6\u53D1effect\u7684\u4F9D\u8D56\u6536\u96C6 \u672C\u53E5\u4E0E\u4E0A\u53E5\u8FDB\u884C\u5165\u4E86\u6B7B\u5FAA\u73AF\r\n      // })\r\n      if (activeEffect != effect) {\r\n        effect.run(); //\u90FD\u4F1A\u91CD\u65B0\u4F9D\u8D56\u6536\u96C6\r\n      }\r\n    });\r\n  }\r\n}\r\n//\u89E3\u91CA1\r\n//\u9ED8\u8BA4\u6267\u884C\u4E86\u4E00\u4E2Aset\u3002\u5728\u5F53\u524D\u7684set\u4E2D\u6E05\u7A7A\u4E86\u67D0\u4E00\u4E2Aeffect\uFF0C\u53C8\u5411set\u4E2D\u6DFB\u52A0\u4E86\u4E00\u9879  \u4F8B\u5B50\u5982\u4E0B\r\n//\u4F7F\u7528\u4E86\u540C\u4E00\u4E2A\u5730\u5740\r\n// let s = new Set([\"a\"]);\r\n// s.forEach((item) => {\r\n//   s.delete(item);\r\n//   s.add(item);\r\n// });\r\n", "export function isObject(value){\r\n    return value !== null && typeof value === \"object\"\r\n}", "import { activeEffect, track, trigger } from \"./effect\";\r\nimport { ReactiveFlags } from \"./reactive\";\r\n\r\nexport const mutableHandlers = {\r\n  //\u7528\u6237\u53D6\u503C\u64CD\u4F5C\r\n  get(target, key, receiver) {\r\n    //\u68C0\u67E5\u662F\u4E0D\u662Freactive\u8FC7\u7684\u5BF9\u8C61\u662F\u4E0D\u662F\u53C8\u88AB\u5957\u4E86\u4E00\u5C42reactive\r\n    if (ReactiveFlags.IS_REACTIVE == key) {\r\n      return true;\r\n    }\r\n    //\u5C06\u4F9D\u8D56\u8FDB\u884C\u6536\u96C6 \u4E3Aeffect\u800C\u505A\u7684\r\n    track(target, key);\r\n\r\n    return Reflect.get(target, key, receiver); //\u5904\u7406this\u7684\u6307\u5411\r\n  },\r\n  //\u7528\u6237\u590D\u5236\u64CD\u4F5C\r\n  set(target, key, value, receiver) {\r\n    //\u8001\u503C\r\n    const oldValue = target[key];\r\n    const t = Reflect.set(target, key, value, receiver);\r\n    //\u8001\u503C\u4E0E\u65B0\u503C\u8FDB\u884C\u5BF9\u6BD4\r\n    if (oldValue !== value) {\r\n      trigger(target, key, value, oldValue);\r\n    } \r\n    return t; //\u5904\u7406this\u7684\u6307\u5411\r\n  },\r\n};\r\n", "import { isObject } from \"@vue/shared\";\r\nimport { mutableHandlers } from \"./baseHandler\";\r\n\r\nexport const enum ReactiveFlags {\r\n  IS_REACTIVE = \"__V_isReactive\",\r\n}\r\n\r\nconst reactiveMap = new Map();\r\nexport function reactive(target) {\r\n  //\u4E0D\u662F\u5BF9\u8C61\u5C31\u8FD4\u56DE\r\n  if (!isObject(target)) return target;\r\n  //\u68C0\u67E5\u662F\u4E0D\u662Freactive\u8FC7\u7684\u5BF9\u8C61\u662F\u4E0D\u662F\u53C8\u88AB\u5957\u4E86\u4E00\u5C42reactive\r\n  if (target[ReactiveFlags.IS_REACTIVE]) {\r\n    return target;\r\n  } \r\n  //\u68C0\u67E5\u77E5\u662F\u4E0D\u662F\u5B58\u5728\u4E4B\u524D\u7684\u4EE3\u7406\u5BF9\u8C61\r\n  const exisitsProxy = reactiveMap.get(target);\r\n  if (exisitsProxy) return exisitsProxy;\r\n  //\u4EE3\u7406\r\n  const proxy = new Proxy(target, mutableHandlers);\r\n  //\u7F13\u5B58\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61 \u4E0B\u6B21\u518D\u884C\u4EE3\u7406\u7684\u65F6\u5019\u76F4\u63A5\u62FF\u51FA\u6765\u4F7F\u7528\r\n  reactiveMap.set(target, proxy);\r\n  return proxy;\r\n}\r\n"],
  "mappings": ";AAAO,IAAI;AAGX,SAAS,cAAcA,SAAQ;AAC7B,MAAI,EAAE,KAAK,IAAIA;AAEf,WAAS,QAAQ,GAAG,QAAQ,KAAK,QAAQ,SAAS;AAEhD,WAAO,KAAK;AAAA,EACd;AAEA,EAAAA,QAAO,KAAK,SAAS;AACvB;AAEA,IAAM,iBAAN,MAAqB;AAAA,EAKnB,YAAY,IAAI;AAHhB,SAAO,SAAS;AAChB,SAAO,OAAO,CAAC;AACf,SAAO,SAAS;AAEd,SAAK,KAAK;AAAA,EACZ;AAAA,EAEA,MAAM;AAEJ,QAAI,CAAC,KAAK,QAAQ;AAChB,aAAO,KAAK,GAAG;AAAA,IACjB;AAGA,QAAI;AAEF,WAAK,SAAS;AACd,qBAAe;AAEf,oBAAc,IAAI;AAClB,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AAEA,qBAAe,KAAK;AACpB,WAAK,SAAS;AAAA,IAChB;AAAA,EACF;AAAA,EAEA,OAAO;AAEL,QAAI,KAAK,QAAQ;AACf,oBAAc,IAAI;AAClB,WAAK,SAAS;AACd,cAAQ,IAAI,gCAAO;AAAA,IACrB;AAAA,EACF;AACF;AAEO,SAAS,OAAO,IAAI;AACzB,QAAM,UAAU,IAAI,eAAe,EAAE;AACrC,UAAQ,IAAI;AAEZ,QAAM,SAAS,QAAQ,IAAI,KAAK,OAAO;AACvC,SAAO,SAAS;AAChB,SAAO;AACT;AAOA,IAAM,YAAY,oBAAI,QAAQ;AACvB,SAAS,MAAM,QAAQ,KAAK;AACjC,MAAI,CAAC,cAAc;AAEjB;AAAA,EACF;AACA,MAAI,UAAU,UAAU,IAAI,MAAM;AAClC,MAAI,CAAC,SAAS;AAGZ,cAAU,IAAI,QAAS,UAAU,oBAAI,IAAI,CAAE;AAAA,EAC7C;AAEA,MAAI,MAAM,QAAQ,IAAI,GAAG;AACzB,MAAI,CAAC,KAAK;AACR,YAAQ,IAAI,KAAM,MAAM,oBAAI,IAAI,CAAE;AAAA,EACpC;AAEA,MAAI,cAAc,CAAC,IAAI,IAAI,YAAY;AACvC,MAAI,aAAa;AAEf,QAAI,IAAI,YAAY;AAEpB,iBAAa,KAAK,KAAK,GAAG;AAAA,EAG5B;AACF;AAUO,SAAS,QAAQ,QAAQ,KAAK,UAAU,UAAU;AAGvD,QAAM,SAAS,UAAU,IAAI,MAAM;AACnC,MAAI,CAAC;AAAQ;AAEb,QAAM,MAAM,OAAO,IAAI,GAAG;AAC1B,MAAI,KAAK;AAEP,UAAM,UAAU,CAAC,GAAG,GAAG;AACvB,YAAQ,QAAQ,CAACA,YAAW;AAQ1B,UAAI,gBAAgBA,SAAQ;AAC1B,QAAAA,QAAO,IAAI;AAAA,MACb;AAAA,IACF,CAAC;AAAA,EACH;AACF;;;AChIO,SAAS,SAAS,OAAM;AAC3B,SAAO,UAAU,QAAQ,OAAO,UAAU;AAC9C;;;ACCO,IAAM,kBAAkB;AAAA,EAE7B,IAAI,QAAQ,KAAK,UAAU;AAEzB,8CAAiC,KAAK;AACpC,aAAO;AAAA,IACT;AAEA,UAAM,QAAQ,GAAG;AAEjB,WAAO,QAAQ,IAAI,QAAQ,KAAK,QAAQ;AAAA,EAC1C;AAAA,EAEA,IAAI,QAAQ,KAAK,OAAO,UAAU;AAEhC,UAAM,WAAW,OAAO;AACxB,UAAM,IAAI,QAAQ,IAAI,QAAQ,KAAK,OAAO,QAAQ;AAElD,QAAI,aAAa,OAAO;AACtB,cAAQ,QAAQ,KAAK,OAAO,QAAQ;AAAA,IACtC;AACA,WAAO;AAAA,EACT;AACF;;;ACvBO,IAAW,gBAAX,kBAAWC,mBAAX;AACL,EAAAA,eAAA,iBAAc;AADE,SAAAA;AAAA,GAAA;AAIlB,IAAM,cAAc,oBAAI,IAAI;AACrB,SAAS,SAAS,QAAQ;AAE/B,MAAI,CAAC,SAAS,MAAM;AAAG,WAAO;AAE9B,MAAI,OAAO,qCAA4B;AACrC,WAAO;AAAA,EACT;AAEA,QAAM,eAAe,YAAY,IAAI,MAAM;AAC3C,MAAI;AAAc,WAAO;AAEzB,QAAM,QAAQ,IAAI,MAAM,QAAQ,eAAe;AAE/C,cAAY,IAAI,QAAQ,KAAK;AAC7B,SAAO;AACT;",
  "names": ["effect", "ReactiveFlags"]
}
